function redirect(e){window.location.href=location.protocol+"//"+location.host+"/"+e}function checkToken(){(null==localStorage.token||void 0==localStorage.token||""==localStorage.token)&&redirect("login.html")}var app=angular.module("app",["ngRoute"]),API_ADDRESS="http://api.promote4.me";app.config(function(e,o){e.when("/",{templateUrl:"views/home.html",controller:"homeController"}).when("/dashboard",{templateUrl:"views/dashboard.html",controller:"dashboardController"}).when("/checkin",{templateUrl:"views/checkin.html",controller:"checkinController"}).when("/locations",{templateUrl:"views/locations.html",controller:"locationController"}).when("/messages",{templateUrl:"views/messages.html",controller:"messagesController"}).when("/team",{templateUrl:"views/team.html",controller:"teamController"}).when("/settings",{templateUrl:"views/settings.html",controller:"settingsController"}).when("/logout",{templateUrl:"views/logout.html",controller:"authController"}).when("/login",{templateUrl:"views/login.html",controller:"authController"}),o.resourceUrlWhitelist(["self",/^https?:\/\/(cdn\.)?promote4.me/])}),app.directive("fileOnChange",function(){return{restrict:"A",link:function(e,o,t){var n=e.$eval(t.fileOnChange);o.bind("change",n)}}}),app.controller("sidebarController",function(e){e.showingSidebar=!1,e.showSidebar=function(){e.showingSidebar?($("#sidebar").animate({"margin-left":"-90px"}),e.showingSidebar=!1):($("#sidebar").animate({"margin-left":"0px"}),e.showingSidebar=!0)}}),app.controller("masterController",function(e){angular.element(document).ready(function(){var e=$(window).outerWidth(),o=$("#sidebar").css("margin-left").replace("px",""),t=$("#sidebar").outerWidth(),n=$("#page").css("padding-left");n=parseInt(n),o=parseInt(o),$("#page").width(e+o+10),$("#page_spillover").width(e+t)}),angular.element(window).resize(function(){var e=$(window).outerWidth(),o=$("#sidebar").css("margin-left").replace("px",""),t=$("#sidebar").outerWidth(),n=$("#page").css("padding-left");n=parseInt(n),o=parseInt(o),$("#page").width(e+o+10),$("#page_spillover").width(e+t)})}),app.controller("homeController",function(){var e=localStorage.token;null===e||void 0===e?window.location.href="login.html":window.location.href="#/dashboard"}),app.controller("dashboardController",function(e){}),app.controller("checkinController",function(e,o){e.openFileWindow=function(){$("#photo_upload").click()},e.uploadPhoto=function(e){var t=e.target.files,n=new FormData;t.length>0&&n.append("p4_image_upload",t[0]),$.ajax({url:"http://images.promote4.me",type:"POST",data:n,cache:!1,dataType:"json",processData:!1,contentType:!1,success:function(e,t,n){if("undefined"==typeof e.error){var l={photo:{photo_id:e.image_id,photo_lat:e.lat,photo_long:e.lon}};o.post(API_ADDRESS+"/user/checkin?token="+localStorage.token,l)}else console.log("ERRORS: "+e.error)},error:function(e,o,t){console.log("ERRORS: "+o)}})}}),app.controller("locationController",function(e,o){e.locations=new Array,navigator.geolocation.getCurrentPosition(function(t){var n=t.coords.latitude,l=t.coords.longitude;o.get(API_ADDRESS+"/geo/nearby?lat="+n+"&lng="+l+"&token="+localStorage.token).success(function(o){o.locations.length>0&&(e.locations=o.locations)})}),e.nearLocations=function(){navigator.geolocation.getCurrentPosition(function(t){var n=t.coords.latitude,l=t.coords.longitude;o.get(API_ADDRESS+"/geo/nearby?lat="+n+"&lng="+l+"&token="+localStorage.token).success(function(o){e.locations=o.locations})})},e.allLocations=function(){o.get(API_ADDRESS+"/subscriber/locations?token="+localStorage.token).success(function(o){e.locations=o})}}),app.controller("messagesController",function(e,o){e.composeMessage={to:null,body:null},o.get(API_ADDRESS+"/message/inbox?token="+localStorage.token).success(function(o){e.messages=o}),o.get(API_ADDRESS+"/user/teammembers?token="+localStorage.token).success(function(o){e.users=o}),e.deleteMessage=function(e,t){o.get(API_ADDRESS+"/message/"+e.message_id+"/delete?token="+localStorage.token).success(function(e){"ok"==e.status&&$(t.currentTarget).closest(".message").fadeOut().promise().done(function(){$(this).remove()})})},e.messageReply=function(e){$("#to_user").children("option").removeAttr("selected"),$("#to_user").find("option[value="+e.from_user_id+"]").attr("selected","selected"),$("#message_modal").modal("show")},e.sendMessage=function(e){var t={msg:{to:e.to,body:e.body}};o.post(API_ADDRESS+"/message/send?token="+localStorage.token,t).success(function(e){"ok"==e.status&&($("#message_sent").fadeIn(),$("#message_modal").modal("hide"),setTimeout(function(){$("#message_sent").fadeOut()},3e3))})},e.expandMessage=function(e){var o=$(e.currentTarget),t=$(e.toElement);t.is("i")||($(o).is(".message_options_shown")?$(o).removeClass("message_options_shown").find(".message_options").slideUp():($(".message_options_shown").removeClass("message_options_shown").find(".message_options").slideUp(),$(o).find(".message_options").slideDown(),$(o).addClass("message_options_shown")))}}),app.controller("teamController",function(){}),app.controller("settingsController",function(){}),app.controller("authController",function(e,o){e.auth={email_address:"",password:""},e.logout=function(){localStorage.token=null,redirect("/login.html")},e.login=function(t){o.post(API_ADDRESS+"/auth/authenticate",{auth:e.auth}).success(function(e){"ok"===e.status?(localStorage.token=e.token,redirect("#/dashboard")):$("#login_error").fadeIn()})}});